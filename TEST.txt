from fastapi import FastAPI, UploadFile
import subprocess
import base64

app = FastAPI()

def get_fps(video_bytes: bytes) -> float:
    # 一時ファイルに書き出して ffprobe で FPS を取得
    import tempfile
    with tempfile.NamedTemporaryFile(delete=False, suffix=".mp4") as tmp:
        tmp.write(video_bytes)
        tmp_path = tmp.name

    cmd = [
        "ffprobe", "-v", "0", "-of", "csv=p=0",
        "-select_streams", "v:0",
        "-show_entries", "stream=r_frame_rate",
        tmp_path
    ]
    out = subprocess.check_output(cmd).decode().strip()
    num, den = map(int, out.split("/"))
    return num / den if den != 0 else float(num)

@app.post("/frame/")
async def extract_frame(file: UploadFile, number: int):
    # 動画をメモリに読み込む
    video_bytes = await file.read()

    # FPS を取得して秒数を計算
    fps = get_fps(video_bytes)
    seconds = number / fps

    # ffmpeg で stdout に直接フレームを出力
    cmd = [
        "ffmpeg",
        "-i", "pipe:0",
        "-ss", str(seconds),
        "-frames:v", "1",
        "-f", "image2",
        "pipe:1"
    ]
    process = subprocess.Popen(
        cmd,
        stdin=subprocess.PIPE,
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE
    )
    img_bytes, _ = process.communicate(input=video_bytes)

    # 画像を Base64 に変換して JSON で返す
    img_base64 = base64.b64encode(img_bytes).decode("utf-8")
    return {
        "time": seconds,
        "image_base64": img_base64
    }
